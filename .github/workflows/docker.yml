name: Sync Home Assistant from GHCR

on:
  push:
    paths:
      - 'versions.txt'
  workflow_dispatch:

env:
  ALIYUN_REGISTRY: ${{ secrets.ALIYUN_REGISTRY }}
  ALIYUN_NAMESPACE: ${{ secrets.ALIYUN_NAMESPACE }}
  VERSIONS_FILE: 'versions.txt'

jobs:
  version_loader:
    runs-on: ubuntu-latest
    outputs:
      versions: ${{ steps.load_versions.outputs.versions }}
      valid_versions: ${{ steps.validate_versions.outputs.valid_versions }}
    steps:
      - uses: actions/checkout@v3

      - name: Load version list
        id: load_versions
        run: |
          versions=$(cat $VERSIONS_FILE | grep -v '^#' | grep -v '^$' | jq -R -s -c 'split("\n") | map(select(. != ""))')
          echo "versions=${versions}" >> $GITHUB_OUTPUT

      - name: Validate versions exist in GHCR
        id: validate_versions
        run: |
          valid_versions=()
          for image_version in $(cat $VERSIONS_FILE | grep -v '^#' | grep -v '^$'); do
            IFS=':' read -r image_type version <<< "$image_version"
            case "$image_type" in
              home-assistant)
                if docker manifest inspect ghcr.io/home-assistant/home-assistant:$version >/dev/null 2>&1; then
                  valid_versions+=("$image_type:$version")
                  echo "âœ… Version $version exists for home-assistant"
                else
                  echo "::warning::Version $version does not exist for home-assistant"
                fi
                ;;
              cli|audio|dns|multicast|observer|odmd)
                if docker manifest inspect ghcr.io/home-assistant/$image_type:$version >/dev/null 2>&1; then
                  valid_versions+=("$image_type:$version")
                  echo "âœ… Version $version exists for $image_type"
                else
                  echo "::warning::Version $version does not exist for $image_type"
                fi
                ;;
              *)
                echo "::error::Unsupported image type: $image_type"
                exit 1
                ;;
            esac
          done
          echo "valid_versions=$(jq -c -n '$ARGS.positional' --args "${valid_versions[@]}")" >> $GITHUB_OUTPUT

  image_sync:
    needs: version_loader
    if: ${{ needs.version_loader.outputs.valid_versions != '[]' && fromJSON(needs.version_loader.outputs.valid_versions) != [] }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        image_version: ${{ fromJSON(needs.version_loader.outputs.valid_versions) }}
        include:
          - image_type: home-assistant
            arch_suffix: "homeassistant"
            arches: >-
              [
                "", "amd64-", "i386-", "armhf-", "armv7-", "aarch64-",
                "generic-x86-64-", "intel-nuc-", "khadas-vim3-",
                "odroid-c2-", "odroid-c4-", "odroid-m1-", "odroid-n2-",
                "odroid-xu-", "qemuarm-", "qemuarm-64-", "qemux86-",
                "qemux86-64-", "raspberrypi-", "raspberrypi2-",
                "raspberrypi3-", "raspberrypi3-64-", "raspberrypi4-",
                "raspberrypi4-64-", "raspberrypi5-64-", "tinker-",
                "yellow-", "green-"
              ]
          # ç»„ä»¶é•œåƒæ¶æ„
          - image_type: cli
            arch_suffix: "hassio-cli"
            arches: >-
              ["amd64-", "i386-", "armhf-", "armv7-", "aarch64-"]
          - image_type: audio
            arch_suffix: "hassio-audio"
            arches: >-
              ["amd64-", "i386-", "armhf-", "armv7-", "aarch64-"]
          - image_type: dns
            arch_suffix: "hassio-dns"
            arches: >-
              ["amd64-", "i386-", "armhf-", "armv7-", "aarch64-"]
          - image_type: multicast
            arch_suffix: "hassio-multicast"
            arches: >-
              ["amd64-", "i386-", "armhf-", "armv7-", "aarch64-"]
          - image_type: observer
            arch_suffix: "hassio-observer"
            arches: >-
              ["amd64-", "i386-", "armhf-", "armv7-", "aarch64-"]
          - image_type: odmd
            arch_suffix: "hassio-odmd"
            arches: >-
              ["amd64-", "i386-", "armhf-", "armv7-", "aarch64-"]
    steps:
      - uses: actions/checkout@v3

      - name: Parse image type and version
        id: parse
        run: |
          IFS=':' read -r image_type version <<< "${{ matrix.image_version }}"
          echo "image_type=${image_type}" >> $GITHUB_OUTPUT
          echo "version=${version}" >> $GITHUB_OUTPUT

      - name: Login to Aliyun
        uses: docker/login-action@v2
        with:
          registry: ${{ env.ALIYUN_REGISTRY }}
          username: ${{ secrets.ALIYUN_USERNAME }}
          password: ${{ secrets.ALIYUN_PASSWORD }}

      - name: Login to GHCR
        run: echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Sync images
        run: |
          image_type="${{ steps.parse.outputs.image_type }}"
          version="${{ steps.parse.outputs.version }}"
          arch_suffix="${{ matrix.arch_suffix }}"
          
          # ç‰¹æ®Šå¤„ç†ä¸»é•œåƒçš„æ— å‰ç¼€æƒ…å†µ
          if [[ "$image_type" == "home-assistant" ]]; then
            default_arch="home-assistant"
            if docker manifest inspect ghcr.io/home-assistant/$default_arch:$version >/dev/null 2>&1; then
              echo "ğŸš€ Syncing $default_arch:$version"
              docker pull ghcr.io/home-assistant/$default_arch:$version
              docker tag ghcr.io/home-assistant/$default_arch:$version ${{ env.ALIYUN_REGISTRY }}/${{ env.ALIYUN_NAMESPACE }}/$default_arch:$version
              docker push ${{ env.ALIYUN_REGISTRY }}/${{ env.ALIYUN_NAMESPACE }}/$default_arch:$version
              
              # ä¸»é•œåƒé¢å¤–æ ‡ç­¾
              docker tag ghcr.io/home-assistant/$default_arch:$version ${{ env.ALIYUN_REGISTRY }}/${{ env.ALIYUN_NAMESPACE }}/$default_arch:latest
              docker push ${{ env.ALIYUN_REGISTRY }}/${{ env.ALIYUN_NAMESPACE }}/$default_arch:latest
              
              if [[ "$version" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
                ym_tag=$(echo "$version" | awk -F. '{print $1"."$2}')
                docker tag ghcr.io/home-assistant/$default_arch:$version ${{ env.ALIYUN_REGISTRY }}/${{ env.ALIYUN_NAMESPACE }}/$default_arch:stable
                docker tag ghcr.io/home-assistant/$default_arch:$version ${{ env.ALIYUN_REGISTRY }}/${{ env.ALIYUN_NAMESPACE }}/$default_arch:$ym_tag
                docker push ${{ env.ALIYUN_REGISTRY }}/${{ env.ALIYUN_NAMESPACE }}/$default_arch:stable
                docker push ${{ env.ALIYUN_REGISTRY }}/${{ env.ALIYUN_NAMESPACE }}/$default_arch:$ym_tag
              fi
              
              docker rmi ghcr.io/home-assistant/$default_arch:$version || true
            fi
          fi
          
          # å¤„ç†æ‰€æœ‰æ¶æ„å˜ä½“
          arches=${{ fromJSON(format('{0}{1}{2}', '[', matrix.arches, ']')) }}
          for arch_prefix in ${arches[@]}; do
            src_image="ghcr.io/home-assistant/${arch_prefix}${arch_suffix}"
            dest_image="${{ env.ALIYUN_REGISTRY }}/${{ env.ALIYUN_NAMESPACE }}/${arch_prefix}${arch_suffix}"
            
            echo "ğŸ” Checking ${src_image}:$version"
            if docker manifest inspect ${src_image}:$version >/dev/null 2>&1; then
              echo "ğŸš€ Syncing ${arch_prefix}${arch_suffix}:$version"
              docker pull ${src_image}:$version
              docker tag ${src_image}:$version ${dest_image}:$version
              docker push ${dest_image}:$version
              
              # ä»…ä¸»é•œåƒæ‰“latestæ ‡ç­¾
              if [[ "$image_type" == "home-assistant" ]]; then
                docker tag ${src_image}:$version ${dest_image}:latest
                docker push ${dest_image}:latest
              fi
              
              docker rmi ${src_image}:$version || true
            else
              echo "::warning::Skipping ${arch_prefix}${arch_suffix} (not available)"
            fi
          done
